<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>map iframe</title>
	<link rel="stylesheet" type="text/css" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css">
	<style type="text/css">
		body,html{
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%
		}
		#mapContainer{
			height: 100%;
		}
        .BMap_cpyCtrl{
            display: none;
        }
        .anchorBL{
            display: none;
        }
	</style>
</head>
<body>
	<div id="mapContainer">地图初始化中</div>
	<span id="quit_panorama" class="province" style="display:none;position: absolute;top: 10px;right: 10px;z-index: 9999;color: #000;font-size:20px;cursor: pointer;"> 退出全景图 </span>
	<script src="./plugin/jquery.min.js"></script>
	<script src="./plugin/echarts-all.js"></script>
	<script type="text/javascript" src="./plugin/mapData.js"></script>
	<script type="text/javascript" src="./plugin/mapext.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=2.0&ak=ZTzBAjmIj8aIRzd0Asaqeybs0PjfBAUj"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
	<script type="text/javascript">
		window.onload=function(){
			var myMapChart = new BMapExt(document.getElementById('mapContainer'), BMap, echarts);
            var map = myMapChart.getMap();

            var startPoint ={
                x: 114.025973657,
                y: 22.5460535462
            };
            var point = new BMap.Point(startPoint.x, startPoint.y);
            this.cityList=["深圳市南山区","深圳市福田区","深圳市罗湖区","深圳市龙岗区","深圳市龙华区","深圳市盐田区","深圳市宝安区","深圳市坪山区"
            ]
            var that=this
            for(var j=0;j<cityList.length;j++){
            	test()(j)
            	
            }
            function test(){
            	var that=this
            	return function(index){
            		setTimeout(function(){
	            		var area=that.cityList[index]
	            		that.getBoundary(area);

	            	},index*50)
            	}
            }
            // getBoundary();
            // getBoundary();
            // getBoundary();
            // getBoundary();
            // getBoundary();
            // getBoundary();
            // getBoundary();
            map.centerAndZoom(point, 10);
            map.enableScrollWheelZoom(true);
            map.setMapStyle({style:'midnight'});
            var list = mapData.mark_proto;

            var panorama = new BMap.Panorama('mapContainer');
            for(var i=0;i<list.length;i++){
                var poi = new BMap.Point(list[i].point.x,list[i].point.y);
                var marker = new BMap.Marker(poi);
                addClickHandler(marker,list[i]);
                map.addOverlay(marker);
                (function(poi, marker){
                    marker.addEventListener("dblclick", function(e){
                        var p = e.target;                                        
                        panorama.setPosition(poi); //根据经纬度坐标展示全景图
                        panorama.show();
                        $('#quit_panorama').show().off('click').on('click',function(){
                            panorama.hide();
                            $('#quit_panorama').hide();
                        });     
                    });
                    
                })(poi, marker);
            }
            function addClickHandler(marker,item){
                marker.addEventListener("click",function(){
                    
                    var infoWindow = new BMapLib.SearchInfoWindow(map,item.tooltip.formatter,{
                        title  : item.name,      //标题
                        width  : 300,             //宽度
                        height : 105,              //高度
                        panel  : "panel",         //检索结果面板
                        enableAutoPan : true,     //自动平移
                        searchTypes   :[
                            BMAPLIB_TAB_SEARCH,   //周边检索
                            BMAPLIB_TAB_TO_HERE,  //到这里去
                            BMAPLIB_TAB_FROM_HERE //从这里出发
                        ]
                    });
                    infoWindow.open(marker)
                });
            }
            this.getBoundary=function(area){       
                var bdary = new BMap.Boundary();
                try{
                	bdary.get(area, function(rs){       //获取行政区域
	                    // map.clearOverlays();        //清除地图覆盖物  
	                    var count = rs.boundaries.length; //行政区域的点有多少个
	                    if (count === 0) {
	                        alert('未能获取当前输入行政区域');
	                        return ;
	                    }
	                    var pointArray = [];
	                    for (var i = 0; i < count; i++) {
	                        var ply = new BMap.Polygon(rs.boundaries[i], {strokeWeight: 1, strokeColor: "#87cefa",fillOpacity:0.3}); //建立多边形覆盖物
	                        map.addOverlay(ply);  //添加覆盖物
	                        pointArray = pointArray.concat(ply.getPath());
	                    }    
	                    // map.setViewport(pointArray);    //调整视野  
	                }); 
                }
                catch(e){
                	console.log("获取行政区域丢包")
                  
            	}
            }
		}
	</script>
</body>
</html>